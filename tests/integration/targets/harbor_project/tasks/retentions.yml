---

- name: create project with a retention of 4 versions
  harbor_project:
    harbor_url: "{{ harbor_url }}"
    harbor_username: "{{ harbor_admin_user }}"
    harbor_password: "{{ harbor_admin_password }}"
    versions_retained: 4
    name: test_project
    state: present
  register: creation_result

- assert:
    that:
      - "creation_result.changed == true"
      - "creation_result.project.retention.rules[0].params.latestPushedK == 4"
      - 'creation_result.project.retention.rules[0].tag_selectors[0].pattern == "*.*.*"'


- name: Test idempotency with retention set
  harbor_project:
    harbor_url: "{{ harbor_url }}"
    harbor_username: "{{ harbor_admin_user }}"
    harbor_password: "{{ harbor_admin_password }}"
    versions_retained: 4
    name: test_project
    state: present
  register: creation_result

- assert:
    that:
      - "creation_result.changed == false"
      - "creation_result.project.retention.rules[0].params.latestPushedK == 4"
      - 'creation_result.project.retention.rules[0].tag_selectors[0].pattern == "*.*.*"'


- name: change retention to 10 versions
  harbor_project:
    harbor_url: "{{ harbor_url }}"
    harbor_username: "{{ harbor_admin_user }}"
    harbor_password: "{{ harbor_admin_password }}"
    versions_retained: 10
    name: test_project
    state: present
  register: creation_result

- assert:
    that:
      - "creation_result.changed == true"
      - "creation_result.project.retention.rules[0].params.latestPushedK == 10"
      - 'creation_result.project.retention.rules[0].tag_selectors[0].pattern == "*.*.*"'


- name: remove retention for our project
  harbor_project:
    harbor_url: "{{ harbor_url }}"
    harbor_username: "{{ harbor_admin_user }}"
    harbor_password: "{{ harbor_admin_password }}"
    name: test_project
    state: present
  register: creation_result

- assert:
    that:
      - "creation_result.changed == true"
      - "creation_result.project.retention.rules | length == 0"


- name: clear project
  harbor_project:
    harbor_url: "{{ harbor_url }}"
    harbor_username: "{{ harbor_admin_user }}"
    harbor_password: "{{ harbor_admin_password }}"
    name: test_project
    state: absent
